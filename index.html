<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>COVID19 Dash</title>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <style>
      body{
          padding: 25px;
          font-family: 'Open Sans', sans-serif;
          font-size: 1.1em;
      }
      .card {
          margin: 10px;
          box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
          height: 500px;
          width: 85%;
          border-radius: 7px;
      }
      input {
          border-radius: 5px;
          height: 20px;
          margin: 10px;
          border: 0px;
          padding: 4px;
      }
      p {
          margin-left: 10px;
      }
      select {
          font-size: 1em;
      }
      input {
          font-size: 1em;
      }
  </style>

<link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">


</head>

<body bgcolor="#d1cfce">
    <p>Filter by number of cases
         <input type="text" id="limit" name="limit" value="5000" onchange="change_limit()">
         <br>
         Country <select id="country" onchange="change_country()"></select>
    </p>
    <div class="card" id="country_chart" ></div>
    <div class="card" id="chart1" ></div>
    <div class="card" id="chart2" ></div>
    <div class="card" id="chart3" ></div>

    <script>
        let has_loaded = false;

        function change_limit() {
            fetch_data();
        }

        function change_country() {
            value = document.getElementById('country').value;
            fetch_data();
        }
        function parse_data(data) {
            let limit = document.getElementById("limit").value;
            cleaned = [];
            d100 = [];
            deaths = [];
            overall = [];
            countries = [];
            for (let c in data) {
                countries.push(c);
                temp = {'name': c, 'data': [], keep: false};
                t100 = {'name': c, 'data': [], 'keep': false};
                tempD = {name: c, data: [], keep: false};
                for (var i=0; i< data[c].length; i++) {
                    let day = data[c][i];
                    if(day['confirmed'] > limit) {
                        temp['keep'] = true;
                        t100['keep'] = true;
                        tempD['keep'] = true;
                    }
                    ds = day['date'].split('-');
                    date = Date.UTC(ds[0], ds[1]-1, ds[2])
                    temp['data'].push([date, day['confirmed']]);
                    tempD['data'].push([date, day['deaths']/(day['confirmed']/100)])
                    if(day['confirmed']>=100){
                        t100['data'].push(day['confirmed']);
                    }
                }

                if(temp['keep']===true) {
                    cleaned.push(temp);
                    d100.push(t100);
                    deaths.push(tempD);
                }
                overall.push(temp);  
            }
            // build country selector
            countries.sort();
            if(has_loaded===false) {
                let selector = document.getElementById('country');
                for(var i=0;i< countries.length; i++) {
                    let option = document.createElement('option');
                    option.setAttribute('value', countries[i]);
                    if(countries[i]==='US'){
                        option.setAttribute('selected', true);
                    }
                    t = document.createTextNode(countries[i]);
                    option.appendChild(t);
                    selector.appendChild(option);
                }
            }
            has_loaded = true;
            country = document.getElementById('country').value;
            for(var i=0;i<overall.length;i++) {
                if (overall[i]['name'] != country) {
                    continue;
                }
                build_chart([overall[i]], 'country_chart', 'datetime', overall[i]['name'], 'Cases');
            }

            build_chart(cleaned, 'chart1', 'datetime', 'Cases by Country', 'Cases');
            build_chart(d100, 'chart2', 'linear', 'Cases since first 100', 'Cases');
            build_chart(deaths, 'chart3', 'datetime', 'Deaths per 100 Cases', 'Deaths');
        }

        function fetch_data() {
            fetch("https://pomber.github.io/covid19/timeseries.json")
            .then(response => response.json())
            .then(json => {
                console.log(json);
                parse_data(json);
                });
        }
        
        
        
        function build_chart(data, id, chartType, title, yLabel) {
            Highcharts.chart(id, {
                xAxis: {
                    type: chartType
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: title
                },
                yAxis: {
                    title: {
                        text: yLabel,
                        style: {
                            'font-size': "18px"
                        }
                    },
                    
                },
                chart: {
                    zoomType: 'xy',
                    // backgroundColor: "#999897"
                },
                series: data,
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false
                        }
                    }
                }
            });
        }

        fetch_data();
        
    </script>
</body>
</html>
